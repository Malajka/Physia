---
import PageHeader from "@/components/common/PageHeader.astro";
import MuscleTestForm from "@/components/muscle-test-selection/MuscleTestForm";
import EmptyState from "@/components/ui/EmptyState.astro";
import ErrorAlert from "@/components/ui/ErrorAlert.astro";
import Layout from "@/layouts/Layout.astro";
import { getMuscleTestsPageData } from "@/lib/services/muscle-test-page-data";

// Server-side guards
// Prevent prerendering and require auth and disclaimer acceptance
export const prerender = false;

// Server-side guard: require authenticated session and disclaimer acceptance
const authRes = await Astro.locals.supabase.auth.getSession();
const session = authRes.data.session;
if (!session) {
  return Astro.redirect('/login');
}
if (!session.user.user_metadata?.disclaimer_accepted_at) {
  return Astro.redirect('/body-parts');
}

// Load all data for the page (fetch tests, title, backLink, etc.)
const { muscleTests, fetchError, pageTitle, bodyPartId, backLink } = await getMuscleTestsPageData(Astro);
---

<Layout title={pageTitle}>
  <div class="container mx-auto py-8">
    <PageHeader
      title={pageTitle}
      subtitle="Please rate the pain intensity for each test on a scale from 0 (no pain) to 10 (severe pain that prevents work)."
    />

    {
      fetchError ? (
        <ErrorAlert message={fetchError} {...backLink} />
      ) : muscleTests.length > 0 ? (
        <MuscleTestForm client:load bodyPartId={bodyPartId} muscleTests={muscleTests} />
      ) : (
        <EmptyState message="No muscle tests available for this body part." {...backLink} />
      )
    }
  </div>
</Layout>
