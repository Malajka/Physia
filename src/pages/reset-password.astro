---
import { AuthForm } from "@/components/auth/AuthForm";
import { PasswordField } from "@/components/auth/PasswordField";
import { ErrorAlert } from "@/components/ui/ErrorAlert";
import { LinkButton } from "@/components/ui/LinkButton";
import Layout from "@/layouts/Layout.astro";

export const prerender = false;

// Get token from query parameter
const token = Astro.url.searchParams.get("token");
const hasValidToken = !!token;
---

<Layout title="Reset Password - Physia">
  <div class="container mx-auto max-w-md p-4">
    <header class="mb-8 text-center">
      <a href="/" class="inline-block">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Reset Password</h1>
      </a>
    </header>

    <main class="bg-white rounded-lg shadow-md p-6 md:p-8">
      {
        hasValidToken ? (
          <AuthForm
            title="Set New Password"
            onSubmit={async (formData) => {
              // Placeholder: handle reset password with token and form data
              console.log("Reset password form submitted with token:", token, formData);
              // Return success result to satisfy AuthFormSubmitResult
              return { success: true };
            }}
            submitText="Reset Password"
            client:load
          >
            <input type="hidden" id="token" value={token} />

            <PasswordField
              id="password"
              label="New Password"
              placeholder="Min. 8 characters"
              required
              value=""
              onChange={(value) => console.log(value)}
              client:load
            />

            <PasswordField
              id="password-confirm"
              label="Confirm New Password"
              placeholder="Confirm your new password"
              required
              value=""
              onChange={(value) => console.log(value)}
              client:load
            />

            <p class="text-sm text-gray-600 mt-2">Password must be at least 8 characters long.</p>
          </AuthForm>
        ) : (
          <div>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Reset Password</h2>
            <ErrorAlert errors="Invalid or expired password reset link. Please request a new password reset." client:load />
            <div class="mt-6 text-center">
              <LinkButton href="/forgot-password" client:load>
                Request New Reset Link
              </LinkButton>
            </div>
          </div>
        )
      }

      <div class="mt-6 text-center">
        <LinkButton href="/login" variant="secondary" client:load> Back to Login </LinkButton>
      </div>
    </main>

    <footer class="mt-8 text-center text-sm text-slate-500">
      <p>&copy; {new Date().getFullYear()} Physia. All rights reserved.</p>
    </footer>
  </div>
</Layout>
