<!-- ---
import { SessionGenerationLoading } from "@/components/session/SessionGenerationLoading";
import Layout from "@/layouts/Layout.astro";

// Disable prerendering and enforce server-side guards
export const prerender = false;

// Require authenticated session and disclaimer acceptance
// const authRes = await Astro.locals.supabase.auth.getSession();
// if (!authRes.data.session) {
//   return Astro.redirect("/login");
// }
// if (!authRes.data.session.user.user_metadata?.disclaimer_accepted_at) {
//   return Astro.redirect("/body-parts");
// }

// Parse query parameters
const { searchParams } = new URL(Astro.request.url);
const bodyPartIdParam = searchParams.get("bodyPartId");
const testsParam = searchParams.get("tests");

let bodyPartId: number | undefined;
let tests: { muscle_test_id: number; pain_intensity: number }[] = [];

try {
  // Parse and validate the body part ID
  if (bodyPartIdParam) {
    bodyPartId = parseInt(bodyPartIdParam, 10);
    if (isNaN(bodyPartId)) {
      bodyPartId = undefined;
    }
  }

  // Parse and validate the tests array
  if (testsParam) {
    const decodedTests = decodeURIComponent(testsParam);
    const parsedTests = JSON.parse(decodedTests);
    if (
      Array.isArray(parsedTests) &&
      parsedTests.every(
        (test) =>
          typeof test.muscle_test_id === "number" && typeof test.pain_intensity === "number" && test.pain_intensity >= 0 && test.pain_intensity <= 10
      )
    ) {
      tests = parsedTests;
    }
  }
} catch {
  // Error parsing query parameters - using default values
}

const pageTitle = "Generating Training Plan";
---

<Layout title={pageTitle}>
  @ts-ignore -->
  <!-- <SessionGenerationLoading bodyPartId={bodyPartId || 0} tests={tests} client:load />
</Layout> -->
import type { APIRoute } from "astro";

export const POST: APIRoute = async ({ locals }) => {
  const supabase = locals.supabase;
  console.log("TEST KROK 3: Próba wykonania pierwszego zapytania do Supabase.");
  try {
    const { data, error } = await supabase.from("body_parts").select("id").limit(1);

    if (error) {
      console.error("KRYTYCZNY BŁĄD ZAPYTANIA SUPABASE:", error);
      throw new Error(`Błąd zapytania do Supabase: ${error.message}`);
    }

    console.log("TEST KROK 3: Zapytanie do Supabase wykonane pomyślnie.", data);
    return new Response(JSON.stringify({ message: "Test Krok 3 zakończony sukcesem." }), { status: 200 });
  } catch (e) {
    const errorMessage = e instanceof Error ? e.message : "Nieznany błąd w Kroku 3.";
    console.error("BŁĄD ZŁAPANY W KROKU 3:", errorMessage);
    return new Response(JSON.stringify({ error: errorMessage }), { status: 500 });
  }
};

