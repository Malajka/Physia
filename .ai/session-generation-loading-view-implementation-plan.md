# Session Generation Loading View Implementation Plan

## 1. Overview
The **Session Generation Loading View** serves to inform the user that their personalized training plan is being generated by the AI + physiotherapist engine. It provides visual feedback while the long-running POST `/api/sessions` operation executes, preventing confusion and improving UX for asynchronous generation.

## 2. Routing
- **Path**: `/session/generate`
- **Astro page**: `src/pages/session/generate.astro`
- Loaded as a client component with `client:load` to initiate generation logic on mount.

## 3. Component Structure
```plaintext
SessionGenerationLoadingPage (Astro)
└── SessionGenerationLoading (React, client:load)
    ├── LoadingIndicator (Shadcn UI Spinner)
    ├── StatusMessage (aria-live)
    └── SkeletonPlaceholders (Shadcn UI Skeleton components)
```

## 4. Component Details

### 4.1 SessionGenerationLoadingPage (`src/pages/session/generate.astro`)
- Wraps the React client component in `MainLayout`.
- Passes query or history state (`bodyPartId`, `tests`) via props or URLSearchParams.

### 4.2 SessionGenerationLoading (`src/components/session/SessionGenerationLoading.tsx`)
**Description**: Manages the session‐creation flow, displays real‐time status, handles errors, and redirects on success.

**Main Elements**:
- `<Spinner />` from Shadcn UI as `LoadingIndicator`.
- `<p role="status" aria-live="polite">` for dynamic `statusMessage`.
- A grid of `<Skeleton>` blocks mimicking the final training plan layout.

**Events**:
- `useEffect` on mount → calls `startGeneration()` from `useSessionGeneration` hook.
- `onClick` Retry button → re-invoke `startGeneration()`.

**Validation**:
- Bail out if `bodyPartId` or `tests` is missing/invalid → show error and link back to muscle tests page.

**Types & Props**:
```ts
// Props passed to the page component
interface SessionGenerationLoadingProps {
  bodyPartId: number;
  tests: { muscle_test_id: number; pain_intensity: number }[];
}

// Local ViewModel state
interface SessionGenerationState {
  statusMessage: string;
  error: string | null;
}

// API contracts imported
import { CreateSessionCommandDto, SessionDetailDto } from "../../types";
```

## 5. Types
- **CreateSessionCommandDto** (from `src/types.ts`):
  - `body_part_id: number`
  - `tests: { muscle_test_id: number; pain_intensity: number }[]`

- **SessionDetailDto** (from `src/types.ts`): detailed session with `training_plan`, `session_tests`, and `feedback_rating`.

- **SessionGenerationState** (view state):
  - `statusMessage: string` — describes current step (e.g. "Inserting session record", "Calling AI engine", "Finalizing plan").
  - `error: string | null` — error message if generation fails.

## 6. State Management
- **Custom Hook**: `useSessionGeneration` (`src/lib/hooks/useSessionGeneration.ts`)
  - **Inputs**: `bodyPartId`, `tests`
  - **Outputs**: `{ statusMessage, error, retry, isLoading, sessionDetail }`
  - Internally updates `statusMessage` at each promise step and catches errors.

## 7. API Integration
- **Endpoint**: `POST /api/sessions`
- **Request Body**: `CreateSessionCommandDto`
- **Success**: HTTP 201 → parse JSON into `SessionDetailDto`
- **Error**: Show user-friendly message. On `403` with code `disclaimer_required`, redirect to Disclaimer page.

## 8. User Interactions
1. **Mount** → view reads params/state, invokes `startGeneration()`.
2. **Loading** → spinner + changing status messages + skeletons.
3. **Error** → display error text and a "Retry" button.
4. **Success** → navigate to session detail page `/sessions/${sessionDetail.id}`.

## 9. Conditions & Validation
- **Missing Inputs**: If `bodyPartId` or `tests` is empty → show "Invalid request" and a back link.
- **API Validation**: Frontend must only send integer IDs and pain intensities between 0–10.
- **Disclaimer Check**: If API returns 403/disclaimer_required → auto-redirect.

## 10. Error Handling
- **Network/HTTP Errors**: Display `error` message from hook.
- **Timeout**: Suggest "Server timeout. Please try again."
- **Unexpected Shapes**: Fallback to generic error and log to console.

## 11. Implementation Steps
1. Create `src/pages/session/generate.astro` using `MainLayout` and load `SessionGenerationLoading` with `client:load`.
2. Build `SessionGenerationLoading.tsx` in `src/components/session/`:
   - Implement the UI skeleton, status, spinner, retry logic.
3. Author `useSessionGeneration` hook in `src/lib/hooks/useSessionGeneration.ts` to orchestrate API calls and status updates.
4. Integrate Shadcn/ui:
   - `<Spinner />`, `<Skeleton />`, `<Button />` for retry.
5. Wire navigation:
   - On success: `window.location.href = "/sessions/" + sessionDetail.id` or use router API.
   - On 403: redirect to `/disclaimer`.
6. Add Tailwind classes for styling and responsive layout.
7. Write unit tests for hook behavior (status transitions, error states).
8. Add integration/E2E test covering click Submit → loading view → final redirect.
